{% extends 'base.html' %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4">Pesanan Dibatalkan</h2>

    {# Display messages #}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    {# Manual Input Form - Visible only to admin and staff gudang #}
    {% if user.profile.is_admin or user.profile.is_staff_gudang %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Input Manual Pesanan Dibatalkan
        </div>
        <div class="card-body">
            <form id="cancelledOrderForm" method="POST"> {# Added method="POST" #}
                {% csrf_token %} {# Added CSRF token #}
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="nomorPesanan" class="form-label">Nomor Pesanan <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" id="nomorPesanan" name="nomor_pesanan" required>
                    </div>
                    <div class="col-md-4">
                        <label for="tanggalPemesanan" class="form-label">Tanggal Pemesanan <span class="text-danger">*</span></label> {# Added Tanggal Pemesanan #}
                        <input type="text" class="form-control form-control-sm datepicker" id="tanggalPemesanan" name="tanggal_pemesanan" placeholder="YYYY-MM-DD" required>
                    </div>
                    <div class="col-md-4">
                        <label for="tanggalPembatalan" class="form-label">Tanggal Pembatalan <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm datepicker" id="tanggalPembatalan" name="tanggal_pembatalan" placeholder="YYYY-MM-DD" required>
                    </div>
                    <div class="col-md-8">
                        <label for="namaProduk" class="form-label">Produk</label> {# Removed required asterisk #}
                        <input type="text" class="form-control form-control-sm" id="namaProduk" name="produk"> {# Removed required attribute #}
                    </div>
                    <div class="col-md-4">
                        <label for="jumlahProduk" class="form-label">Jumlah <span class="text-danger">*</span></label>
                        <input type="number" class="form-control form-control-sm" id="jumlahProduk" name="jumlah" min="1" required>
                    </div>
                    <div class="col-12">
                        <label for="alasanPembatalan" class="form-label">Alasan Pembatalan</label>
                        <textarea class="form-control form-control-sm" id="alasanPembatalan" name="alasan_pembatalan" rows="2"></textarea>
                    </div>
                </div>
            </form> {# End of cancelledOrderForm #}

            {# Buttons Container #}
            <div class="mt-3 d-flex justify-content-end">
                {# Save Button - Submits the main form #}
                <button type="submit" form="cancelledOrderForm" class="btn btn-success btn-sm me-2"> {# Added me-2 for margin #}
                    <i class="bi bi-save me-1"></i> Simpan Data
                </button>

                {# Reset Button Form - Separate form #}
                <form method="POST" action="{% url 'inventory:reset_cancelled_orders' %}" onsubmit="return confirm('Anda yakin ingin menghapus semua data pesanan dibatalkan? Data yang dihapus tidak dapat dikembalikan.');" style="display: inline;"> {# Removed margin-right #}
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="bi bi-trash me-1"></i> Reset Data
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {# Table Section #}
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-striped mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Nomor Pesanan</th>
                            <th>Tanggal Pemesanan</th> {# Updated header #}
                            <th>Tanggal Pembatalan</th> {# Added header #}
                            <th>Produk</th>
                            <th class="text-center">Jumlah</th>
                            <th>Alasan Pembatalan</th>
                            <th class="text-center">Aksi</th> {# Added Aksi column #}
                        </tr>
                    </thead>
                    <tbody>
                        {# Dynamic rendering of cancelled orders #}
                        {% for order in cancelled_orders %}
                        <tr>
                            <td>{{ order.order_number }}</td>
                            <td>{{ order.order_date|date:"Y-m-d" }}</td>
                            <td>{{ order.cancellation_date|date:"Y-m-d" }}</td>
                            <td>{{ order.product_name|default:"-" }}</td>
                            <td class="text-center">{{ order.quantity }}</td>
                            <td>{{ order.cancellation_reason|default:"-" }}</td>
                            <td class="text-center">
                                <form method="POST" action="{% url 'inventory:send_cancelled_order_telegram' order.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-info btn-sm" title="Kirim ke Telegram">
                                        <i class="bi bi-telegram"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        {# Empty state row #}
                        <tr>
                            <td colspan="6" class="text-center py-5"> {# Updated colspan to 6 #}
                                <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
                                <h5 class="text-muted">Tidak Ada Data Pesanan Dibatalkan</h5>
                                <p class="text-muted">Belum ada data pesanan yang dibatalkan untuk ditampilkan.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize datepicker for both date fields
        flatpickr(".datepicker", {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        // Form submission is now handled by standard POST request, no JS needed for basic submit
        // const form = document.getElementById('cancelledOrderForm');
        // if (form) {
        //     form.addEventListener('submit', function(event) {
        //         // event.preventDefault(); // Removed preventDefault to allow standard POST
        //         // No alert needed, backend handles messages
        //     });
        // }
    });
</script>
{% endblock %}


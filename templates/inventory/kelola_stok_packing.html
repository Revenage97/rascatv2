{% extends 'base.html' %}

{% load static %}

{% block extra_head %}
<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token }}">
<script src="{% static 'js/csrf.js' %}"></script>
{% endblock %}

{% block content %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="container-fluid py-4">
    <h2 class="mb-4">Kelola Stok Packing</h2>

    <!-- Manual Input Form - Visible only to admin users -->
    {% if is_admin %}
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Input Manual Data Stok Packing</h5>
        </div>
        <div class="card-body">
            <form id="manualInputForm" class="row g-3">
                <div class="col-md-6">
                    <label for="inputKodeBarang" class="form-label">Kode Barang <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="inputKodeBarang" required>
                    <div class="invalid-feedback">Kode Barang wajib diisi</div>
                </div>
                <div class="col-md-6">
                    <label for="inputNamaBarang" class="form-label">Nama Barang <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="inputNamaBarang" required>
                    <div class="invalid-feedback">Nama Barang wajib diisi</div>
                </div>
                <div class="col-md-4">
                    <label for="inputKategori" class="form-label">Kategori</label>
                    <input type="text" class="form-control" id="inputKategori">
                </div>
                <div class="col-md-4">
                    <label for="inputStokSaatIni" class="form-label">Stok Saat Ini <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="inputStokSaatIni" min="0" value="0" required>
                    <div class="invalid-feedback">Stok Saat Ini wajib diisi dengan angka minimal 0</div>
                </div>
                <div class="col-md-4">
                    <label for="inputStokMinimum" class="form-label">Request Stock</label>
                    <input type="number" class="form-control" id="inputStokMinimum" min="0" value="0">
                </div>
                <div class="col-12 text-end">
                    <button type="button" id="btnSimpanManual" class="btn btn-success">
                        <i class="bi bi-save"></i> Simpan Data
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Toolbar -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-2 mb-lg-0">
                    {% if is_admin or is_staff_gudang %} {# Allow staff gudang to see payment method #}
                    <div class="d-flex flex-wrap align-items-center">
                        <div class="d-flex align-items-center flex-grow-1 me-2 mb-2 mb-sm-0">
                            <label for="paymentMethod" class="form-label me-2 mb-0 flex-shrink-0">Metode Pembayaran</label>
                            <select class="form-select" id="paymentMethod">
                                <option value="" selected>Pilih Metode Pembayaran</option>
                                <option value="BANK BNI">BANK BNI</option>
                                <option value="BANK BCA">BANK BCA</option>
                                <option value="SHOPEE PAY">SHOPEE PAY</option>
                            </select>
                        </div>
                        <div class="d-flex">
                            <button type="button" id="savePaymentMethod" class="btn btn-primary me-2">
                                <i class="bi bi-save"></i> <span class="d-none d-sm-inline">Simpan</span>
                            </button>
                            <button type="button" id="resetPaymentMethod" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-counterclockwise"></i> <span class="d-none d-sm-inline">Reset</span>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="col-lg-6">
                    <div class="d-flex flex-wrap justify-content-lg-end">
                        <button id="sendToTelegramBtn" class="btn btn-info me-2 mb-2 mb-sm-0" disabled>
                            <i class="bi bi-telegram"></i> Kirim ke Telegram
                        </button>
                        <div class="btn-group me-2 mb-2 mb-sm-0">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-filter"></i> Filter
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="?sort=name">Urutkan berdasarkan Nama (A-Z)</a></li>
                                <li><a class="dropdown-item" href="?sort=name_desc">Urutkan berdasarkan Nama (Z-A)</a></li>
                                <li><a class="dropdown-item" href="?sort=category">Urutkan berdasarkan Kategori (A-Z)</a></li>
                                <li><a class="dropdown-item" href="?sort=category_desc">Urutkan berdasarkan Kategori (Z-A)</a></li>
                                <li><a class="dropdown-item" href="?sort=stock_asc">Urutkan berdasarkan Stok (Terendah-Tertinggi)</a></li>
                                <li><a class="dropdown-item" href="?sort=stock_desc">Urutkan berdasarkan Stok (Tertinggi-Terendah)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="?filter=low_stock">Stok di bawah minimum</a></li>
                                <li><a class="dropdown-item" href="?">Reset Filter</a></li>
                            </ul>
                        </div>
                        {% if is_admin %}
                        <button id="resetDataBtn" class="btn btn-danger mb-2 mb-sm-0">
                            <i class="bi bi-trash"></i> Reset Data
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-striped">
                    <thead class="bg-light">
                        <tr>
                            <th class="text-center" style="width: 40px;">
                                <div class="d-flex align-items-center justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>Kode Barang</th>
                            <th style="min-width: 200px;">Nama Barang</th>
                            <th style="min-width: 150px;">Kategori</th>
                            <th class="text-center">Stok Saat Ini</th>
                            <th class="text-center">Request Stock</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input item-checkbox" type="checkbox" value="{{ item.id }}" id="item{{ item.id }}">
                                </div>
                            </td>
                            <td data-field="code" data-item-id="{{ item.id }}">{{ item.code }}</td> {# No edit buttons #}
                            <td data-field="name" data-item-id="{{ item.id }}">{{ item.name }}</td> {# No edit buttons #}
                            <td>{{ item.category }}</td>
                            <td class="text-center">
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control form-control-sm current-stock-input" 
                                           data-item-id="{{ item.id }}" value="{{ item.current_stock }}" min="0">
                                    <button class="btn btn-outline-secondary save-current-stock" type="button" data-item-id="{{ item.id }}">
                                        <i class="bi bi-save"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control form-control-sm min-stock-input" 
                                           data-item-id="{{ item.id }}" value="{{ item.minimum_stock }}" min="0">
                                    <button class="btn btn-outline-secondary save-min-stock" type="button" data-item-id="{{ item.id }}">
                                        <i class="bi bi-save"></i>
                                    </button>
                                    <button class="btn btn-outline-danger delete-min-stock" type="button" data-item-id="{{ item.id }}">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-info send-single-item me-1" data-item-id="{{ item.id }}">
                                    <i class="bi bi-telegram"></i>
                                </button>
                                {% if is_admin %}
                                <button type="button" class="btn btn-sm btn-danger delete-packing-item" data-item-id="{{ item.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">Tidak ada data barang</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Konfirmasi Reset Data -->
<div class="modal fade" id="resetDataModal" tabindex="-1" aria-labelledby="resetDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetDataModalLabel">Konfirmasi Reset Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Apakah Anda yakin ingin mereset semua data Request Stock menjadi 0?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-danger" id="confirmResetData">Ya, Reset</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notifikasi</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const sendToTelegramBtn = document.getElementById('sendToTelegramBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const resetDataModalEl = document.getElementById('resetDataModal');
        const resetDataModal = resetDataModalEl ? new bootstrap.Modal(resetDataModalEl) : null; // Added null check
        const confirmResetDataBtn = document.getElementById('confirmResetData');
        const toastEl = document.getElementById('notificationToast');
        const toast = toastEl ? new bootstrap.Toast(toastEl) : null; // Added null check
        const toastMessage = document.getElementById('toastMessage');
        
        // Payment Method elements
        const paymentMethodSelect = document.getElementById('paymentMethod');
        const savePaymentMethodBtn = document.getElementById('savePaymentMethod');
        const resetPaymentMethodBtn = document.getElementById('resetPaymentMethod');
        
        // Load saved payment method from localStorage if exists
        if (paymentMethodSelect) { // Added null check
            const savedPaymentMethod = localStorage.getItem('packingPaymentMethod');
            if (savedPaymentMethod) {
                paymentMethodSelect.value = savedPaymentMethod;
            }
        }
        
        // Payment Method Save button
        if (savePaymentMethodBtn && paymentMethodSelect) { // Added null checks
            savePaymentMethodBtn.addEventListener('click', function() {
                const selectedMethod = paymentMethodSelect.value;
                if (!selectedMethod) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Perhatian',
                        text: 'Silakan pilih metode pembayaran terlebih dahulu',
                        confirmButtonColor: '#3085d6'
                    });
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem('packingPaymentMethod', selectedMethod);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil',
                    text: 'Metode pembayaran berhasil disimpan',
                    confirmButtonColor: '#3085d6'
                });
            });
        }
        
        // Payment Method Reset button
        if (resetPaymentMethodBtn && paymentMethodSelect) { // Added null checks
            resetPaymentMethodBtn.addEventListener('click', function() {
                // Reset dropdown to default
                paymentMethodSelect.value = '';
                
                // Remove from localStorage
                localStorage.removeItem('packingPaymentMethod');
                
                Swal.fire({
                    icon: 'info',
                    title: 'Reset',
                    text: 'Metode pembayaran telah direset',
                    confirmButtonColor: '#3085d6'
                });
            });
        }
        
        // Manual Input Form Handling
        const manualInputForm = document.getElementById('manualInputForm');
        const btnSimpanManual = document.getElementById('btnSimpanManual');
        
        if (btnSimpanManual && manualInputForm) { // Added null check for form
            btnSimpanManual.addEventListener('click', function() {
                // Validate form
                const kodeBarangInput = document.getElementById('inputKodeBarang');
                const namaBarangInput = document.getElementById('inputNamaBarang');
                const kategoriInput = document.getElementById('inputKategori');
                const stokSaatIniInput = document.getElementById('inputStokSaatIni');
                const stokMinimumInput = document.getElementById('inputStokMinimum');

                const kodeBarang = kodeBarangInput.value.trim();
                const namaBarang = namaBarangInput.value.trim();
                const kategori = kategoriInput.value.trim();
                const stokSaatIni = stokSaatIniInput.value;
                const stokMinimum = stokMinimumInput.value;
                
                // Reset validation state
                manualInputForm.querySelectorAll('.is-invalid').forEach(el => {
                    el.classList.remove('is-invalid');
                });
                
                // Validate required fields
                let isValid = true;
                
                if (!kodeBarang) {
                    kodeBarangInput.classList.add('is-invalid');
                    isValid = false;
                }
                
                if (!namaBarang) {
                    namaBarangInput.classList.add('is-invalid');
                    isValid = false;
                }
                
                if (!stokSaatIni || isNaN(stokSaatIni) || parseInt(stokSaatIni) < 0) {
                    stokSaatIniInput.classList.add('is-invalid');
                    isValid = false;
                }
                 // Validate min stock only if not empty
                if (stokMinimum && (isNaN(stokMinimum) || parseInt(stokMinimum) < 0)) {
                     stokMinimumInput.classList.add('is-invalid');
                     isValid = false;
                }
                
                if (!isValid) {
                    return;
                }
                
                // Show loading
                Swal.fire({
                    title: 'Menyimpan data...',
                    text: 'Mohon tunggu sebentar',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Send data to server
                fetch('/api/create-packing-item/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        code: kodeBarang,
                        name: namaBarang,
                        category: kategori,
                        current_stock: parseInt(stokSaatIni),
                        minimum_stock: parseInt(stokMinimum || 0) // Default to 0 if empty
                    })
                })
                .then(response => response.json())
                .then(data => {
                    Swal.close();
                    
                    if (data.status === 'success') {
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil',
                            text: 'Data berhasil disimpan',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                        // Add new row to table
                        addNewRowToTable(data.item);
                        
                        // Reset form
                        manualInputForm.reset();
                    } else {
                        // Show error message
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal',
                            text: data.message || 'Terjadi kesalahan saat menyimpan data',
                            confirmButtonColor: '#3085d6'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.close();
                    
                    // Show error message
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal',
                        text: 'Terjadi kesalahan saat menghubungi server',
                        confirmButtonColor: '#3085d6'
                    });
                });
            });
        }
        
        // Function to add new row to table
        function addNewRowToTable(item) {
            const tableBody = document.querySelector('table tbody');
            if (!tableBody) return; // Added null check
            
            // Check if "no data" row exists and remove it
            const noDataRow = tableBody.querySelector('tr td[colspan="7"]');
            if (noDataRow) {
                noDataRow.closest('tr').remove();
            }
            
            // Create new row
            const newRow = document.createElement('tr');
            
            // Create row content (using the structure from the *current* HTML, not baseline)
            newRow.innerHTML = `
                <td class="text-center">
                    <div class="form-check">
                        <input class="form-check-input item-checkbox" type="checkbox" value="${item.id}" id="item${item.id}">
                    </div>
                </td>
                <td data-field="code" data-item-id="${item.id}">${item.code}</td>
                <td data-field="name" data-item-id="${item.id}">${item.name}</td>
                <td>${item.category || ''}</td>
                <td class="text-center">
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control form-control-sm current-stock-input" 
                               data-item-id="${item.id}" value="${item.current_stock}" min="0">
                        <button class="btn btn-outline-secondary save-current-stock" type="button" data-item-id="${item.id}">
                            <i class="bi bi-save"></i>
                        </button>
                    </div>
                </td>
                <td class="text-center">
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control form-control-sm min-stock-input" 
                               data-item-id="${item.id}" value="${item.minimum_stock}" min="0">
                        <button class="btn btn-outline-secondary save-min-stock" type="button" data-item-id="${item.id}">
                            <i class="bi bi-save"></i>
                        </button>
                        <button class="btn btn-outline-danger delete-min-stock" type="button" data-item-id="${item.id}">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-info send-single-item me-1" data-item-id="${item.id}">
                        <i class="bi bi-telegram"></i>
                    </button>
                    {% if is_admin %}
                    <button type="button" class="btn btn-sm btn-danger delete-packing-item" data-item-id="${item.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                </td>
            `;
            
            tableBody.prepend(newRow); // Add to the top
            
            // Update Send Button State after adding row
            updateSendButtonState(); 
        }

        // --- Table Event Listeners (Save/Delete/Send Single) ---
        const tableBody = document.querySelector('table tbody');
        if (tableBody) {
            tableBody.addEventListener('click', function(e) {
                const saveCurrentStockBtn = e.target.closest('.save-current-stock');
                const saveMinStockBtn = e.target.closest('.save-min-stock');
                const deleteMinStockBtn = e.target.closest('.delete-min-stock');
                const sendSingleItemBtn = e.target.closest('.send-single-item');
                const deletePackingItemBtn = e.target.closest('.delete-packing-item');

                // Save Current Stock
                if (saveCurrentStockBtn) {
                    const button = saveCurrentStockBtn;
                    const itemId = button.getAttribute('data-item-id');
                    const input = tableBody.querySelector(`.current-stock-input[data-item-id="${itemId}"]`);
                    const currentStock = input.value;

                    if (currentStock === '' || isNaN(currentStock) || parseInt(currentStock) < 0) {
                        Swal.fire('Error', 'Stok Saat Ini harus berupa angka positif', 'error');
                        return;
                    }

                    button.disabled = true;
                    const originalIconHTML = button.innerHTML;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

                    fetch('/api/update-packing-item/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ item_id: itemId, current_stock: parseInt(currentStock) })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showToast('Stok Saat Ini berhasil diperbarui.');
                        } else {
                            showToast(data.message || 'Gagal memperbarui Stok Saat Ini.', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating current stock:', error);
                        showToast('Terjadi kesalahan saat menghubungi server.', 'danger');
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.innerHTML = originalIconHTML;
                    });
                }

                // Save Request Stock (Minimum Stock)
                else if (saveMinStockBtn) {
                    const button = saveMinStockBtn;
                    const itemId = button.getAttribute('data-item-id');
                    const input = tableBody.querySelector(`.min-stock-input[data-item-id="${itemId}"]`);
                    let minStock = input.value.trim();

                    // Allow 0, but treat empty or negative as 0 after warning
                    if (minStock === '' || isNaN(minStock) || parseInt(minStock) < 0) {
                         Swal.fire('Perhatian', 'Request Stock harus berupa angka 0 atau lebih besar. Menggunakan nilai 0.', 'warning');
                         minStock = 0;
                         input.value = 0; // Update input visually
                    } else {
                        minStock = parseInt(minStock);
                    }

                    button.disabled = true;
                    const originalIconHTML = button.innerHTML;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

                    fetch('/api/update-packing-min-stock/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ item_id: itemId, min_stock: minStock })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showToast('Request Stock berhasil diperbarui.');
                        } else {
                            showToast(data.message || 'Gagal memperbarui Request Stock.', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating min stock:', error);
                        showToast('Terjadi kesalahan saat memperbarui Request Stock.', 'danger');
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.innerHTML = originalIconHTML;
                    });
                }

                // Delete Request Stock (Set to 0)
                else if (deleteMinStockBtn) {
                    const button = deleteMinStockBtn;
                    const itemId = button.getAttribute('data-item-id');
                    const input = tableBody.querySelector(`.min-stock-input[data-item-id="${itemId}"]`);

                    input.value = 0; // Set input to 0 visually

                    button.disabled = true;
                    const originalIconHTML = button.innerHTML;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

                    fetch('/api/update-packing-min-stock/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ item_id: itemId, min_stock: 0 })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showToast('Request Stock disetel ke 0.');
                        } else {
                            showToast(data.message || 'Gagal mengatur Request Stock ke 0.', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting min stock:', error);
                        showToast('Terjadi kesalahan saat menghubungi server.', 'danger');
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.innerHTML = originalIconHTML;
                    });
                }

                // Send Single Item to Telegram
                else if (sendSingleItemBtn) {
                    const selectedPaymentMethod = paymentMethodSelect ? paymentMethodSelect.value : ''; // Get current value, handle null
                    if (!selectedPaymentMethod) {
                        Swal.fire('Perhatian', 'Anda harus memilih metode pembayaran terlebih dahulu', 'warning');
                        return;
                    }
                    const button = sendSingleItemBtn;
                    const itemId = button.getAttribute('data-item-id');
                    const row = button.closest('tr');
                    const itemNameElement = row.querySelector('td:nth-child(3)'); // Assuming Name is 3rd column
                    const requestStockInput = row.querySelector('.min-stock-input');

                    if (!itemNameElement || !requestStockInput) {
                        Swal.fire('Error', 'Tidak dapat menemukan detail item untuk dikirim.', 'error');
                        return;
                    }

                    const itemName = itemNameElement.textContent.trim();
                    const requestStockValue = parseInt(requestStockInput.value, 10);

                    if (isNaN(requestStockValue) || requestStockValue <= 0) {
                        Swal.fire('Perhatian', 'Item ini tidak memiliki Request Stock > 0 untuk dikirim.', 'warning');
                        return;
                    }

                    const now = new Date();
                    const optionsDate = { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' };
                    const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Jakarta' };
                    const jakartaDate = now.toLocaleDateString('id-ID', optionsDate);
                    const jakartaTime = now.toLocaleTimeString('id-ID', optionsTime).replace('.', ':'); // Ensure HH:MM format
                    const formattedTimestamp = `${jakartaTime} - ${jakartaDate}`;

                    let message = `Request Stock ; ${formattedTimestamp}\n`;
                    message += `Metode Pembayaran : ${selectedPaymentMethod}\n`; // Use current selection
                    message += `\n`;
                    message += `${itemName} - ${requestStockValue} Pcs\n`;
                    message += `\n`;
                    message += `Tanpa konfirmasi`;

                    // Send message (using the JSON format endpoint)
                    Swal.fire({
                        title: 'Mengirim notifikasi...',
                        text: 'Mohon tunggu sebentar',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });
                    fetch('/api/send-packing-to-telegram/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json', // Send as JSON
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ text: message }) // Wrap message in JSON
                    })
                    .then(response => response.json())
                    .then(data => {
                        Swal.close();
                        if (data.status === 'success') {
                            Swal.fire('Berhasil', 'Notifikasi berhasil dikirim ke Telegram', 'success');
                        } else {
                            Swal.fire('Gagal', data.message || 'Gagal mengirim notifikasi ke Telegram', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error sending Telegram message:', error);
                        Swal.close();
                        Swal.fire('Gagal', 'Terjadi kesalahan saat mengirim notifikasi ke Telegram', 'error');
                    });
                }

                // Delete Packing Item
                else if (deletePackingItemBtn) {
                    const button = deletePackingItemBtn;
                    const itemId = button.getAttribute('data-item-id');
                    const row = button.closest('tr');
                    const itemName = row.querySelector('td:nth-child(3)').textContent; // Assuming Name is 3rd column

                    Swal.fire({
                        title: 'Konfirmasi Hapus',
                        text: `Apakah Anda yakin ingin menghapus item "${itemName}"?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Ya, Hapus!',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire({ title: 'Menghapus item...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                            fetch('/api/delete-packing-item/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify({ item_id: itemId })
                            })
                            .then(response => response.json())
                            .then(data => {
                                Swal.close();
                                if (data.status === 'success') {
                                    row.style.transition = 'opacity 0.5s ease';
                                    row.style.opacity = '0';
                                    setTimeout(() => {
                                        row.remove();
                                        const remainingRows = tableBody.querySelectorAll('tr');
                                        if (remainingRows.length === 0) {
                                            const noDataRow = document.createElement('tr');
                                            noDataRow.innerHTML = '<td colspan="7" class="text-center">Tidak ada data barang</td>';
                                            tableBody.appendChild(noDataRow);
                                        }
                                        updateSendButtonState(); // Update button state after delete
                                    }, 500);
                                    Swal.fire('Berhasil', 'Item berhasil dihapus', 'success');
                                } else {
                                    Swal.fire('Gagal', data.message || 'Gagal menghapus item', 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error deleting item:', error);
                                Swal.close();
                                Swal.fire('Gagal', 'Terjadi kesalahan saat menghubungi server', 'error');
                            });
                        }
                    });
                }
            });

            // --- Checkbox Handling --- 
            const selectAllCheckbox = document.getElementById('selectAll');
            // const itemCheckboxes = tableBody.querySelectorAll('.item-checkbox'); // Already defined above

            // Update Send Button State function
            function updateSendButtonState() {
                if (!sendToTelegramBtn) return; // Added null check
                const checkedItems = tableBody.querySelectorAll('.item-checkbox:checked');
                sendToTelegramBtn.disabled = checkedItems.length === 0;
            }

            // Select All checkbox listener
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const isChecked = this.checked;
                    tableBody.querySelectorAll('.item-checkbox').forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                    updateSendButtonState();
                });
            }

            // Individual checkbox listener (using delegation)
            tableBody.addEventListener('change', function(e) {
                if (e.target.classList.contains('item-checkbox')) {
                    updateSendButtonState();
                    // Update selectAll state
                    const allCheckboxes = tableBody.querySelectorAll('.item-checkbox');
                    const checkedCheckboxes = tableBody.querySelectorAll('.item-checkbox:checked');
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
                    }
                }
            });

            // Initial state for Send button
            updateSendButtonState();
        }


        // Send to Telegram (Main Button)
        if (sendToTelegramBtn) {
            sendToTelegramBtn.addEventListener('click', function() {
                const selectedPaymentMethod = paymentMethodSelect ? paymentMethodSelect.value : ''; // Get current value, handle null
                if (!selectedPaymentMethod) {
                    Swal.fire('Perhatian', 'Anda harus memilih metode pembayaran terlebih dahulu', 'warning');
                    return;
                }
                const itemsToRequest = [];
                const checkedCheckboxes = document.querySelectorAll('.item-checkbox:checked');

                if (checkedCheckboxes.length === 0) {
                     Swal.fire('Perhatian', 'Tidak ada item yang dipilih untuk dikirim.', 'warning');
                     return;
                }

                checkedCheckboxes.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const itemNameElement = row.querySelector('td:nth-child(3)'); // Assuming Name is 3rd column
                    const requestStockInput = row.querySelector('.min-stock-input');
                    
                    if (itemNameElement && requestStockInput) {
                        const itemName = itemNameElement.textContent.trim();
                        const requestStockValue = parseInt(requestStockInput.value, 10);
                        
                        if (!isNaN(requestStockValue) && requestStockValue > 0) {
                            itemsToRequest.push({ name: itemName, quantity: requestStockValue });
                        }
                    }
                });

                if (itemsToRequest.length === 0) {
                    Swal.fire('Perhatian', 'Tidak ada item terpilih dengan Request Stock > 0 untuk dikirim.', 'warning');
                    return;
                }

                const now = new Date();
                const optionsDate = { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' };
                const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Jakarta' };
                const jakartaDate = now.toLocaleDateString('id-ID', optionsDate);
                const jakartaTime = now.toLocaleTimeString('id-ID', optionsTime).replace('.', ':'); // Ensure HH:MM format
                const formattedTimestamp = `${jakartaTime} - ${jakartaDate}`;

                let message = `Request Stock ; ${formattedTimestamp}\n`;
                message += `Metode Pembayaran : ${selectedPaymentMethod}\n`; // Use current selection
                message += `\n`;
                itemsToRequest.forEach(item => {
                    message += `${item.name} - ${item.quantity} Pcs\n`;
                });
                message += `\n`;
                message += `Tanpa konfirmasi`;

                // Send message (using the JSON format endpoint)
                Swal.fire({
                    title: 'Mengirim notifikasi...',
                    text: 'Mohon tunggu sebentar',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });
                fetch('/api/send-packing-to-telegram/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // Send as JSON
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ text: message }) // Wrap message in JSON
                })
                .then(response => response.json())
                .then(data => {
                    Swal.close();
                    if (data.status === 'success') {
                        Swal.fire('Berhasil', 'Notifikasi berhasil dikirim ke Telegram', 'success');
                    } else {
                        Swal.fire('Gagal', data.message || 'Gagal mengirim notifikasi ke Telegram', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error sending Telegram message:', error);
                    Swal.close();
                    Swal.fire('Gagal', 'Terjadi kesalahan saat mengirim notifikasi ke Telegram', 'error');
                });
            });
        }

        // Reset Data Button
        if (resetDataBtn && confirmResetDataBtn && resetDataModal) { // Added null checks
            resetDataBtn.addEventListener('click', function() {
                resetDataModal.show();
            });
        
            confirmResetDataBtn.addEventListener('click', function() {
                resetDataModal.hide();
                Swal.fire({ title: 'Mereset data...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                fetch('/api/reset-packing-stock/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    Swal.close();
                    if (data.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil',
                            text: 'Semua Request Stock berhasil direset ke 0.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        // Reload page after success
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        Swal.fire('Error', data.message || 'Terjadi kesalahan saat mereset data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error resetting data:', error);
                    Swal.close();
                    Swal.fire('Error', 'Terjadi kesalahan saat menghubungi server', 'error');
                });
            });
        }

        // Function to show toast notifications
        function showToast(message, type = 'success') {
            if (!toast || !toastMessage) return; // Added null checks
            toastMessage.textContent = message;
            toastEl.className = 'toast'; // Reset classes
            let bgClass = 'bg-success';
            let textClass = 'text-white';
            if (type === 'danger') {
                bgClass = 'bg-danger';
            } else if (type === 'warning') {
                bgClass = 'bg-warning';
                textClass = 'text-dark';
            } else if (type === 'info') {
                bgClass = 'bg-info';
                textClass = 'text-dark';
            }
            toastEl.classList.add(bgClass, textClass);
            toast.show();
        }

    });
</script>
{% endblock %}


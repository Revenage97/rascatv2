{% extends 'base.html' %}

{% load static %}

{% block extra_head %}
<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token }}">
<script src="{% static 'js/csrf.js' %}"></script>
{% endblock %}

{% block content %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="container-fluid py-4">
    <h2 class="mb-4">Kelola Stok Packing</h2>
    
    <!-- Manual Input Form - Visible to admin and staff gudang users -->
    {% if is_admin or is_staff_gudang %}
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Input Manual Data Stok Packing</h5>
        </div>
        <div class="card-body">
            <form id="manualInputForm" class="row g-3">
                <div class="col-md-6">
                    <label for="inputKodeBarang" class="form-label">Kode Barang <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="inputKodeBarang" required>
                    <div class="invalid-feedback">Kode Barang wajib diisi</div>
                </div>
                <div class="col-md-6">
                    <label for="inputNamaBarang" class="form-label">Nama Barang <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="inputNamaBarang" required>
                    <div class="invalid-feedback">Nama Barang wajib diisi</div>
                </div>
                <div class="col-md-4">
                    <label for="inputKategori" class="form-label">Kategori</label>
                    <input type="text" class="form-control" id="inputKategori">
                </div>
                <div class="col-md-4">
                    <label for="inputStokSaatIni" class="form-label">Stok Saat Ini <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="inputStokSaatIni" min="0" value="0" required>
                    <div class="invalid-feedback">Stok Saat Ini wajib diisi dengan angka minimal 0</div>
                </div>
                <div class="col-md-4">
                    <label for="inputStokMinimum" class="form-label">Request Stock</label>
                    <input type="number" class="form-control" id="inputStokMinimum" min="0" value="0">
                </div>
                <div class="col-12 text-end">
                    <button type="button" id="btnSimpanManual" class="btn btn-success">
                        <i class="bi bi-save"></i> Simpan Data
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Toolbar -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-2 mb-lg-0">
                    {% if is_admin or is_staff_gudang %} {# Allow staff gudang to see payment method #}
                    <div class="d-flex flex-wrap align-items-center">
                        <div class="d-flex align-items-center flex-grow-1 me-2 mb-2 mb-sm-0">
                            <label for="paymentMethod" class="form-label me-2 mb-0 flex-shrink-0">Metode Pembayaran</label>
                            <select class="form-select" id="paymentMethod">
                                <option value="" selected>Pilih Metode Pembayaran</option>
                                <option value="BANK BNI">BANK BNI</option>
                                <option value="BANK BCA">BANK BCA</option>
                                <option value="SHOPEE PAY">SHOPEE PAY</option>
                            </select>
                        </div>
                        <!-- Removed Save/Reset buttons for payment method as they are not needed -->
                    </div>
                    {% endif %}
                </div>
                <div class="col-lg-6">
                    <div class="d-flex flex-wrap justify-content-lg-end">
                        <button id="sendToTelegramBtn" class="btn btn-info me-2 mb-2 mb-sm-0" disabled>
                            <i class="bi bi-telegram"></i> Kirim ke Telegram
                        </button>
                        <div class="btn-group me-2 mb-2 mb-sm-0">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-filter"></i> Filter
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="?sort=name">Urutkan berdasarkan Nama (A-Z)</a></li>
                                <li><a class="dropdown-item" href="?sort=name_desc">Urutkan berdasarkan Nama (Z-A)</a></li>
                                <li><a class="dropdown-item" href="?sort=category">Urutkan berdasarkan Kategori (A-Z)</a></li>
                                <li><a class="dropdown-item" href="?sort=category_desc">Urutkan berdasarkan Kategori (Z-A)</a></li>
                                <li><a class="dropdown-item" href="?sort=stock_asc">Urutkan berdasarkan Stok (Terendah-Tertinggi)</a></li>
                                <li><a class="dropdown-item" href="?sort=stock_desc">Urutkan berdasarkan Stok (Tertinggi-Terendah)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="?filter=low_stock">Stok di bawah minimum</a></li>
                                <li><a class="dropdown-item" href="?">Reset Filter</a></li>
                            </ul>
                        </div>
                        {% if user.profile.is_admin %}
                        <button id="resetDataBtn" class="btn btn-danger mb-2 mb-sm-0">
                            <i class="bi bi-trash"></i> Reset Data
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-striped">
                    <thead class="bg-light">
                        <tr>
                            <th class="text-center" style="width: 40px;">
                                <div class="d-flex align-items-center justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>Kode Barang</th>
                            <th style="min-width: 200px;">Nama Barang</th>
                            <th style="min-width: 150px;">Kategori</th>
                            <th class="text-center">Stok Saat Ini</th>
                            <th class="text-center">Request Stock</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input item-checkbox" type="checkbox" value="{{ item.id }}" id="item{{ item.id }}">
                                </div>
                            </td>
                            <td data-field="code" data-item-id="{{ item.id }}">{{ item.code }}</td>
                            <td data-field="name" data-item-id="{{ item.id }}">{{ item.name }}</td>
                            <td>{{ item.category }}</td>
                            <td class="text-center">
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control form-control-sm current-stock-input" 
                                           data-item-id="{{ item.id }}" value="{{ item.current_stock }}" min="0">
                                    <button class="btn btn-outline-secondary save-current-stock" type="button" data-item-id="{{ item.id }}">
                                        <i class="bi bi-save"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control form-control-sm min-stock-input" 
                                           data-item-id="{{ item.id }}" value="{{ item.minimum_stock }}" min="0">
                                    <button class="btn btn-outline-secondary save-min-stock" type="button" data-item-id="{{ item.id }}">
                                        <i class="bi bi-save"></i>
                                    </button>
                                    <button class="btn btn-outline-danger delete-min-stock" type="button" data-item-id="{{ item.id }}">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-info send-single-item me-1" data-item-id="{{ item.id }}">
                                    <i class="bi bi-telegram"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger delete-packing-item" data-item-id="{{ item.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">Tidak ada data barang</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Konfirmasi Reset Data -->
<div class="modal fade" id="resetDataModal" tabindex="-1" aria-labelledby="resetDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetDataModalLabel">Konfirmasi Reset Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Apakah Anda yakin ingin mereset semua data Request Stock menjadi 0?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-danger" id="confirmResetData">Ya, Reset</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notifikasi</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const sendToTelegramBtn = document.getElementById('sendToTelegramBtn');
    const resetDataBtn = document.getElementById('resetDataBtn');
    const resetDataModal = new bootstrap.Modal(document.getElementById('resetDataModal'));
    const confirmResetDataBtn = document.getElementById('confirmResetData');
    const toastEl = document.getElementById('notificationToast');
    const toastMessage = document.getElementById('toastMessage');
    const toast = new bootstrap.Toast(toastEl);
    const paymentMethodSelect = document.getElementById("paymentMethod");

    // --- Helper Functions ---
    function showToast(message, type = 'success') {
        toastMessage.textContent = message;
        toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning');
        if (type === 'success') {
            toastEl.classList.add('bg-success', 'text-white');
        } else if (type === 'danger') {
            toastEl.classList.add('bg-danger', 'text-white');
        } else if (type === 'warning') {
            toastEl.classList.add('bg-warning', 'text-dark');
        }
        toast.show();
    }

    function showLoading(title = 'Memproses...', text = 'Mohon tunggu sebentar') {
        Swal.fire({
            title: title,
            text: text,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }

    function showSuccess(title, text, timer = 1500) {
        Swal.fire({
            icon: 'success',
            title: title,
            text: text,
            timer: timer,
            showConfirmButton: false
        });
    }

    function showError(title, text) {
        Swal.fire({
            icon: 'error',
            title: title,
            text: text,
            confirmButtonColor: '#3085d6'
        });
    }

    function showWarning(title, text) {
        Swal.fire({
            icon: 'warning',
            title: title,
            text: text,
            confirmButtonColor: '#3085d6'
        });
    }

    function validatePaymentMethod() {
        if (paymentMethodSelect && !paymentMethodSelect.value) {
            showWarning("Perhatian", "Anda harus memilih metode pembayaran terlebih dahulu");
            return false;
        }
        return true;
    }

    function getFormattedTimestamp() {
        const now = new Date();
        const optionsDate = { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' };
        const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Jakarta' };
        const jakartaDate = now.toLocaleDateString('id-ID', optionsDate);
        const jakartaTime = now.toLocaleTimeString('id-ID', optionsTime).replace('.', ':'); // Ensure HH:MM format
        return `${jakartaTime} - ${jakartaDate}`;
    }

    function sendTelegramMessage(message) {
        showLoading('Mengirim notifikasi...');
        fetch('/api/send-packing-to-telegram/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // Send as JSON
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ text: message }) // Wrap message in JSON
        })
        .then(response => response.json())
        .then(data => {
            Swal.close();
            if (data.status === 'success') {
                showSuccess('Berhasil', 'Notifikasi berhasil dikirim ke Telegram');
            } else {
                showError('Gagal', data.message || 'Gagal mengirim notifikasi ke Telegram');
            }
        })
        .catch(error => {
            console.error('Error sending Telegram message:', error);
            Swal.close();
            showError('Gagal', 'Terjadi kesalahan saat mengirim notifikasi ke Telegram');
        });
    }

    // --- Event Listeners ---

    // Select All Checkbox
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateSendButtonState();
        });
    }

    // Individual Item Checkbox
    document.addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('item-checkbox')) {
            updateSendButtonState();
            // Update selectAll state
            const allCheckboxes = document.querySelectorAll('.item-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
            }
        }
    });

    // Update Send Button State (Enable/Disable)
    function updateSendButtonState() {
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        if (sendToTelegramBtn) {
            sendToTelegramBtn.disabled = checkedItems.length === 0;
        }
    }
    // Initial state check
    updateSendButtonState(); 

    // Save Current Stock
    document.addEventListener('click', function(e) {
        const button = e.target.closest('.save-current-stock');
        if (button) {
            const itemId = button.getAttribute('data-item-id');
            const input = document.querySelector(`.current-stock-input[data-item-id="${itemId}"]`);
            const currentStock = input.value;

            if (currentStock === '' || isNaN(currentStock) || parseInt(currentStock) < 0) {
                showWarning('Error', 'Stok Saat Ini harus berupa angka positif');
                return;
            }

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            fetch('/api/update-packing-item/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ item_id: itemId, current_stock: parseInt(currentStock) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showSuccess('Berhasil', 'Stok Saat Ini berhasil diperbarui');
                } else {
                    showError('Error', data.message || 'Gagal memperbarui Stok Saat Ini');
                }
            })
            .catch(error => {
                console.error('Error updating current stock:', error);
                showError('Error', 'Terjadi kesalahan saat menghubungi server');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-save"></i>';
            });
        }
    });

    // Save Request Stock (Minimum Stock)
    document.addEventListener('click', function(e) {
        const button = e.target.closest('.save-min-stock');
        if (button) {
            const itemId = button.getAttribute('data-item-id');
            const input = document.querySelector(`.min-stock-input[data-item-id="${itemId}"]`);
            let minStock = input.value.trim(); // Trim whitespace

            // Default to 0 if empty or invalid, but allow 0
            if (minStock === '' || isNaN(minStock) || parseInt(minStock) < 0) {
                 if (minStock !== '0') { // Allow explicit 0
                    showWarning('Perhatian', 'Request Stock harus berupa angka 0 atau lebih besar. Menggunakan nilai 0.');
                    minStock = 0;
                    input.value = 0; // Update input visually
                 } else {
                     minStock = 0; // Ensure it's treated as number 0
                 }
            } else {
                minStock = parseInt(minStock);
            }

            // Show loading indicator on button
            button.disabled = true;
            const originalIcon = button.innerHTML;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            fetch('/api/update-packing-min-stock/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ item_id: itemId, min_stock: minStock })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('Request Stock berhasil diperbarui.');
                } else {
                    showToast(data.message || 'Gagal memperbarui Request Stock.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error updating min stock:', error);
                showToast('Terjadi kesalahan saat memperbarui Request Stock.', 'danger');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalIcon;
            });
        }
    });

    // Delete Request Stock (Set to 0)
    document.addEventListener('click', function(e) {
        const button = e.target.closest('.delete-min-stock');
        if (button) {
            const itemId = button.getAttribute('data-item-id');
            const input = document.querySelector(`.min-stock-input[data-item-id="${itemId}"]`);

            input.value = 0;

            // Show loading indicator on button
            button.disabled = true;
            const originalIcon = button.innerHTML;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            fetch('/api/update-packing-min-stock/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ item_id: itemId, min_stock: 0 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showSuccess('Berhasil', 'Request Stock disetel ke 0');
                } else {
                    showError('Error', data.message || 'Gagal mengatur Request Stock ke 0');
                }
            })
            .catch(error => {
                console.error('Error deleting min stock:', error);
                showError('Error', 'Terjadi kesalahan saat menghubungi server');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalIcon;
            });
        }
    });

    // Send to Telegram (Main Button)
    if (sendToTelegramBtn) {
        sendToTelegramBtn.addEventListener('click', function() {
            // 1. Validate Payment Method
            if (!validatePaymentMethod()) {
                return;
            }
            const selectedPaymentMethod = paymentMethodSelect.value;

            // 2. Collect selected items with request stock > 0
            const itemsToRequest = [];
            const checkedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
            
            if (checkedCheckboxes.length === 0) {
                 showWarning('Perhatian', 'Tidak ada item yang dipilih untuk dikirim.');
                 return;
            }

            checkedCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const itemNameElement = row.querySelector('td:nth-child(3)');
                const requestStockInput = row.querySelector('.min-stock-input');
                
                if (itemNameElement && requestStockInput) {
                    const itemName = itemNameElement.textContent.trim();
                    const requestStockValue = parseInt(requestStockInput.value, 10);
                    
                    if (!isNaN(requestStockValue) && requestStockValue > 0) {
                        itemsToRequest.push({ name: itemName, quantity: requestStockValue });
                    }
                }
            });

            if (itemsToRequest.length === 0) {
                showWarning('Perhatian', 'Tidak ada item terpilih dengan Request Stock > 0 untuk dikirim.');
                return;
            }

            // 3. Format timestamp
            const formattedTimestamp = getFormattedTimestamp();

            // 4. Construct the message
            let message = `Request Stock ; ${formattedTimestamp}\n`;
            message += `Metode Pembayaran : ${selectedPaymentMethod}\n`;
            message += `\n`;
            itemsToRequest.forEach(item => {
                message += `${item.name} - ${item.quantity} Pcs\n`;
            });
            message += `\n`;
            message += `Tanpa konfirmasi`;

            // 5. Send message
            sendTelegramMessage(message);
        });
    }

    // Send Single Item to Telegram
    document.addEventListener('click', function(e) {
        const button = e.target.closest('.send-single-item');
        if (button) {
            // 1. Validate Payment Method
            if (!validatePaymentMethod()) {
                return;
            }
            const selectedPaymentMethod = paymentMethodSelect.value;

            // 2. Get item details
            const itemId = button.getAttribute('data-item-id');
            const row = button.closest('tr');
            const itemNameElement = row.querySelector('td:nth-child(3)');
            const requestStockInput = row.querySelector('.min-stock-input');

            if (!itemNameElement || !requestStockInput) {
                showError('Error', 'Tidak dapat menemukan detail item untuk dikirim.');
                return;
            }

            const itemName = itemNameElement.textContent.trim();
            const requestStockValue = parseInt(requestStockInput.value, 10);

            if (isNaN(requestStockValue) || requestStockValue <= 0) {
                showWarning('Perhatian', 'Item ini tidak memiliki Request Stock > 0 untuk dikirim.');
                return;
            }

            // 3. Format timestamp
            const formattedTimestamp = getFormattedTimestamp();

            // 4. Construct the message
            let message = `Request Stock ; ${formattedTimestamp}\n`;
            message += `Metode Pembayaran : ${selectedPaymentMethod}\n`;
            message += `\n`;
            message += `${itemName} - ${requestStockValue} Pcs\n`;
            message += `\n`;
            message += `Tanpa konfirmasi`;

            // 5. Send message
            sendTelegramMessage(message);
        }
    });

    // Delete Packing Item
    document.addEventListener('click', function(e) {
        const button = e.target.closest('.delete-packing-item');
        if (button) {
            const itemId = button.getAttribute('data-item-id');
            const row = button.closest('tr');
            const itemName = row.querySelector('td:nth-child(3)').textContent;

            Swal.fire({
                title: 'Konfirmasi Hapus',
                text: `Apakah Anda yakin ingin menghapus item "${itemName}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading('Menghapus item...');
                    fetch('/api/delete-packing-item/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ item_id: itemId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        Swal.close();
                        if (data.status === 'success') {
                            // Animate removal
                            row.style.transition = 'opacity 0.5s ease';
                            row.style.opacity = '0';
                            setTimeout(() => {
                                row.remove();
                                // Check if table is empty
                                const tableBody = document.querySelector('table tbody');
                                if (tableBody.children.length === 0) {
                                    const noDataRow = document.createElement('tr');
                                    noDataRow.innerHTML = '<td colspan="7" class="text-center">Tidak ada data barang</td>';
                                    tableBody.appendChild(noDataRow);
                                }
                                // Update select all state if needed
                                if (selectAllCheckbox) {
                                    const allCheckboxes = document.querySelectorAll('.item-checkbox');
                                    selectAllCheckbox.checked = allCheckboxes.length === 0 ? false : selectAllCheckbox.checked;
                                }
                                updateSendButtonState(); // Update button state after deletion
                            }, 500);
                            showSuccess('Berhasil', 'Item berhasil dihapus');
                        } else {
                            showError('Gagal', data.message || 'Gagal menghapus item');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting item:', error);
                        Swal.close();
                        showError('Gagal', 'Terjadi kesalahan saat menghubungi server');
                    });
                }
            });
        }
    });

    // Reset Data Button
    if (resetDataBtn) {
        resetDataBtn.addEventListener('click', function() {
            resetDataModal.show();
        });
    }

    // Confirm Reset Data Button
    if (confirmResetDataBtn) {
        confirmResetDataBtn.addEventListener('click', function() {
            resetDataModal.hide();
            showLoading('Mereset data...');
            fetch('/api/reset-packing-stock/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                Swal.close();
                if (data.status === 'success') {
                    showSuccess('Berhasil', 'Semua Request Stock berhasil direset ke 0.', 2000);
                    // Reload page to show updated data
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showError('Error', data.message || 'Terjadi kesalahan saat mereset data');
                }
            })
            .catch(error => {
                console.error('Error resetting data:', error);
                Swal.close();
                showError('Error', 'Terjadi kesalahan saat menghubungi server');
            });
        });
    }

    // Manual Input Form Handling
    const manualInputForm = document.getElementById('manualInputForm');
    const btnSimpanManual = document.getElementById('btnSimpanManual');
    if (manualInputForm && btnSimpanManual) {
        btnSimpanManual.addEventListener('click', function() {
            const kodeBarangInput = document.getElementById('inputKodeBarang');
            const namaBarangInput = document.getElementById('inputNamaBarang');
            const kategoriInput = document.getElementById('inputKategori');
            const stokSaatIniInput = document.getElementById('inputStokSaatIni');
            const stokMinimumInput = document.getElementById('inputStokMinimum');

            const kodeBarang = kodeBarangInput.value.trim();
            const namaBarang = namaBarangInput.value.trim();
            const kategori = kategoriInput.value.trim();
            const stokSaatIni = stokSaatIniInput.value;
            const stokMinimum = stokMinimumInput.value;

            // Reset validation
            manualInputForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            let isValid = true;

            if (!kodeBarang) {
                kodeBarangInput.classList.add('is-invalid');
                isValid = false;
            }
            if (!namaBarang) {
                namaBarangInput.classList.add('is-invalid');
                isValid = false;
            }
            if (!stokSaatIni || isNaN(stokSaatIni) || parseInt(stokSaatIni) < 0) {
                stokSaatIniInput.classList.add('is-invalid');
                isValid = false;
            }
            // Stok minimum is optional, but validate if provided
            if (stokMinimum && (isNaN(stokMinimum) || parseInt(stokMinimum) < 0)) {
                 stokMinimumInput.classList.add('is-invalid');
                 isValid = false;
            }

            if (!isValid) return;

            showLoading('Menyimpan data...');
            fetch('/api/create-packing-item/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    code: kodeBarang,
                    name: namaBarang,
                    category: kategori,
                    current_stock: parseInt(stokSaatIni),
                    minimum_stock: parseInt(stokMinimum || 0) // Default to 0 if empty
                })
            })
            .then(response => response.json())
            .then(data => {
                Swal.close();
                if (data.status === 'success') {
                    showSuccess('Berhasil', 'Data berhasil disimpan');
                    addNewRowToTable(data.item);
                    manualInputForm.reset();
                } else {
                    showError('Gagal', data.message || 'Terjadi kesalahan saat menyimpan data');
                }
            })
            .catch(error => {
                console.error('Error creating item:', error);
                Swal.close();
                showError('Gagal', 'Terjadi kesalahan saat menghubungi server');
            });
        });
    }

    // Function to add new row to table (for manual input)
    function addNewRowToTable(item) {
        const tableBody = document.querySelector('table tbody');
        const noDataRow = tableBody.querySelector('tr td[colspan="7"]');
        if (noDataRow) {
            noDataRow.closest('tr').remove();
        }

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="text-center">
                <div class="form-check">
                    <input class="form-check-input item-checkbox" type="checkbox" value="${item.id}" id="item${item.id}">
                </div>
            </td>
            <td data-field="code" data-item-id="${item.id}">${item.code}</td>
            <td data-field="name" data-item-id="${item.id}">${item.name}</td>
            <td>${item.category || ''}</td>
            <td class="text-center">
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control form-control-sm current-stock-input" 
                           data-item-id="${item.id}" value="${item.current_stock}" min="0">
                    <button class="btn btn-outline-secondary save-current-stock" type="button" data-item-id="${item.id}">
                        <i class="bi bi-save"></i>
                    </button>
                </div>
            </td>
            <td class="text-center">
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control form-control-sm min-stock-input" 
                           data-item-id="${item.id}" value="${item.minimum_stock}" min="0">
                    <button class="btn btn-outline-secondary save-min-stock" type="button" data-item-id="${item.id}">
                        <i class="bi bi-save"></i>
                    </button>
                    <button class="btn btn-outline-danger delete-min-stock" type="button" data-item-id="${item.id}">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-info send-single-item me-1" data-item-id="${item.id}">
                    <i class="bi bi-telegram"></i>
                </button>
                <button type="button" class="btn btn-sm btn-danger delete-packing-item" data-item-id="${item.id}">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tableBody.prepend(newRow);
        // Update select all state if needed
        if (selectAllCheckbox) {
             selectAllCheckbox.checked = false; // New item added, uncheck select all
        }
        updateSendButtonState(); // Update button state after adding
    }

});
</script>
{% endblock %}

